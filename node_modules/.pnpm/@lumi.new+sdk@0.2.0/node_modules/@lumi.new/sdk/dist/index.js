"use strict";var me=Object.create;var L=Object.defineProperty,pe=Object.defineProperties,he=Object.getOwnPropertyDescriptor,de=Object.getOwnPropertyDescriptors,ge=Object.getOwnPropertyNames,Q=Object.getOwnPropertySymbols,fe=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty,ye=Object.prototype.propertyIsEnumerable;var V=i=>{throw TypeError(i)};var J=(i,e,t)=>e in i?L(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,S=(i,e)=>{for(var t in e||(e={}))G.call(e,t)&&J(i,t,e[t]);if(Q)for(var t of Q(e))ye.call(e,t)&&J(i,t,e[t]);return i},H=(i,e)=>pe(i,de(e));var we=(i,e)=>{for(var t in e)L(i,t,{get:e[t],enumerable:!0})},Y=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ge(e))!G.call(i,s)&&s!==t&&L(i,s,{get:()=>e[s],enumerable:!(r=he(e,s))||r.enumerable});return i};var x=(i,e,t)=>(t=i!=null?me(fe(i)):{},Y(e||!i||!i.__esModule?L(t,"default",{value:i,enumerable:!0}):t,i)),Ee=i=>Y(L({},"__esModule",{value:!0}),i);var Z=(i,e,t)=>e.has(i)||V("Cannot "+t);var n=(i,e,t)=>(Z(i,e,"read from private field"),t?t.call(i):e.get(i)),a=(i,e,t)=>e.has(i)?V("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),u=(i,e,t,r)=>(Z(i,e,"write to private field"),r?r.call(i,t):e.set(i,t),t);var m=(i,e,t)=>new Promise((r,s)=>{var o=h=>{try{f(t.next(h))}catch(y){s(y)}},l=h=>{try{f(t.throw(h))}catch(y){s(y)}},f=h=>h.done?r(h.value):Promise.resolve(h.value).then(o,l);f((t=t.apply(i,e)).next())});var Te={};we(Te,{EmailTool:()=>U,EntitiesClient:()=>O,EntityClient:()=>P,FileTool:()=>k,FunctionsClient:()=>M,LumiAuthClient:()=>R,LumiClient:()=>B,ToolsClient:()=>q,createClient:()=>Ce});module.exports=Ee(Te);var ce=require("uuid");var ie=x(require("crypto-js/enc-base64")),re=x(require("crypto-js/enc-hex")),ne=x(require("crypto-js/hmac-sha256")),oe=x(require("crypto-js/sha256")),se=x(require("object-hash")),ae=require("ofetch");var b=class extends Error{constructor(t,r){super(r);this.name="LumiError";this.code=t}};function X(){var i,e;return(e=(i=document.querySelector('link[rel="icon"]'))==null?void 0:i.href)!=null?e:null}function W(){var i;return(i=document.title)!=null?i:null}var w=typeof window=="undefined";var be="6QrJZ7pFCmBZAeIJF7IArvkCz+EtzA0RVcpHkiQIsQyhs7QtCS9P+CueZdHfB2OtJcgX3BbqY9pfpWeAVTqCwQ==";function ee(i){return encodeURIComponent(i).replace(/[!'()*]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`)}function Se(i){return e=>{let{options:t}=e,r=Math.floor(Date.now()/1e3).toString(),s=Math.random().toString(36).substring(2,15),o=S({},t.query),l=Object.keys(o).sort().map(E=>`${ee(E)}=${ee(String(o[E]))}`).join("&"),f={"x-timestamp":r,"x-nonce":s},h=Object.keys(f).sort().map(E=>`${E}:${f[E]}`).join(`
`),y=t.body&&!(t.body instanceof FormData)?JSON.stringify(t.body):"",$=(0,oe.default)(y).toString(re.default),N=[l,h,$].join(`
`),d=ie.default.stringify((0,ne.default)(N,i)),I=new Headers(t.headers);Object.entries(f).forEach(([E,ue])=>{I.set(E,ue)}),I.set("X-Sign",d),t.headers=I}}var te=new Map;function _(i,e){var o;e.body instanceof FormData&&(e=H(S({},e),{body:Array.from(e.body.entries())}));let t=(0,se.default)([i,e]),r=Date.now(),s=((o=te.get(t))==null?void 0:o.filter(l=>r-l<1e3))||[];if(s.length>=4)throw new b(429,"Too many requests");s.push(r),te.set(t,s)}function c(i,e,t={}){i.auth.accessToken&&(t.headers=S({Authorization:`Bearer ${i.auth.accessToken}`},t.headers)),_(e,t);let r=i.auth.isAuthenticated;return(0,ae.ofetch)(e,H(S({baseURL:i.config.apiBaseUrl},t),{onRequest:Se(be),onResponse:({response:s})=>{var o;!w&&r&&((o=s._data)==null?void 0:o.code)===2100&&i.auth.signOut()}}))}function z(i,e,t=localStorage){let r=t.getItem(i),s=e?JSON.stringify(e):null;s?t.setItem(i,s):t.removeItem(i),window.dispatchEvent(new StorageEvent("storage",{key:i,oldValue:r,newValue:s,storageArea:t}))}function K(i,e=localStorage){let t=e.getItem(i);try{return t?JSON.parse(t):null}catch(r){return null}}var g,j,v,R=class{constructor(e){a(this,g);a(this,j,`lumi-auth-${(0,ce.v4)()}`);a(this,v,null);u(this,g,e),Promise.resolve().then(()=>{!w&&this.isAuthenticated&&this.refreshUser()})}get accessToken(){if(w){let e=n(this,g).config.authorization;return e?e.replace("Bearer ",""):null}return K("lumi-access-token")}set accessToken(e){if(w){n(this,g).config.authorization=e?`Bearer ${e}`:void 0;return}z("lumi-access-token",e)}get user(){return w?n(this,v):K("lumi-user")}set user(e){if(w){u(this,v,e);return}z("lumi-user",e)}get isAuthenticated(){return!!this.accessToken}signIn(){if(w)throw new Error("auth.signIn() can only be called on the client side");let e=800,t=600,r=(window.screen.width-e)/2,s=(window.screen.height-t)/2,o=window.open(n(this,g).config.authOrigin,n(this,j),`width=${e},height=${t},left=${r},top=${s}`),l;return new Promise((f,h)=>{if(!o)return h(new Error("Open auth window failed"));let y=setInterval(()=>{o.closed&&h(new Error("Auth window closed"))},1e3),$=d=>{o.closed||(o.focus(),d.stopPropagation(),d.preventDefault())},N=({data:d,origin:I,source:E})=>{if(!(I!==n(this,g).config.authOrigin||E!==o))switch(d==null?void 0:d.type){case"lumi-ready":{o.postMessage({type:"lumi-init",data:{projectId:n(this,g).config.projectId,icon:X(),title:W()}},n(this,g).config.authOrigin);break}case"lumi-sign-in":{if(d.data.projectId!==n(this,g).config.projectId)break;o.close(),window.focus(),this.accessToken=d.data.accessToken,this.user=d.data.user,f(d.data);break}}};window.addEventListener("message",N),document.addEventListener("click",$,!0),l=()=>{clearInterval(y),window.removeEventListener("message",N),document.removeEventListener("click",$,!0)}}).finally(()=>l==null?void 0:l())}signOut(){if(w)throw new Error("auth.signOut() can only be called on the client side");this.accessToken=null,this.user=null}refreshUser(){return m(this,null,function*(){let e=yield c(n(this,g),"/lm/user/info",{method:"POST"});if(e.code!==200)throw new Error(e.message);return this.user=e.data,e.data})}onAuthChange(e){if(w)throw new Error("auth.onAuthChange() can only be called on the client side");let t=r=>{(r.key==="lumi-access-token"||r.key==="lumi-user"||r.key===null)&&e({isAuthenticated:this.isAuthenticated,user:this.user})};return window.addEventListener("storage",t),()=>{window.removeEventListener("storage",t)}}};g=new WeakMap,j=new WeakMap,v=new WeakMap;var p,P=class{constructor(e,t){a(this,p);u(this,p,e),this.entityName=t}list(){return m(this,arguments,function*({filter:e,sort:t,limit:r,skip:s}={}){if(r){let o=yield c(n(this,p),this.uri("/find"),{method:"POST",body:{filter:e,sort:t,limit:r,skip:s}});if(o.code!==200)throw new Error(o.message);return o.data}else{let o=yield c(n(this,p),this.uri("/list"),{method:"POST",body:{filter:e,sort:t}});if(o.code!==200)throw new Error(o.message);return{total:o.data.length,list:o.data}}})}get(e){return m(this,null,function*(){let t=yield c(n(this,p),this.uri(`/${e}`),{method:"GET"});if(t.code!==200)throw new Error(t.message);return t.data})}create(e){return m(this,null,function*(){let t=yield c(n(this,p),this.uri(),{method:"POST",body:e});if(t.code!==200)throw new Error(t.message);return t.data})}createMany(e){return m(this,null,function*(){let t=yield c(n(this,p),this.uri("/batch"),{method:"POST",body:e});if(t.code!==200)throw new Error(t.message);return t.data})}update(e,t){return m(this,null,function*(){let r=yield c(n(this,p),this.uri(),{method:"PUT",body:{filter:{_id:e},update:t}});if(r.code!==200)throw new Error(r.message);return r.data})}delete(e){return m(this,null,function*(){let t=yield c(n(this,p),this.uri(`/${e}`),{method:"DELETE"});if(t.code!==200)throw new Error(t.message)})}deleteMany(e){return m(this,null,function*(){let t=yield c(n(this,p),this.uri("/batch-by-ids"),{method:"DELETE",params:{ids:e}});if(t.code!==200)throw new Error(t.message)})}uri(e=""){return`/lm/${n(this,p).config.projectId}/${this.entityName}/documents${e}`}};p=new WeakMap;var D,O=class{constructor(e){a(this,D);return u(this,D,e),new Proxy(this,{get(t,r){return r in t||(t[r]=new P(n(t,D),r)),t[r]}})}};D=new WeakMap;var le=require("ofetch");var T,M=class{constructor(e){a(this,T);u(this,T,e)}invoke(e,t={}){return n(this,T).auth.accessToken&&(t.headers=S({Authorization:`Bearer ${n(this,T).auth.accessToken}`},t.headers)),_(e,t),(0,le.ofetch)(e,S({},t))}};T=new WeakMap;var A,U=class{constructor(e){a(this,A);u(this,A,e)}send(h){return m(this,arguments,function*({to:e,subject:t,fromName:r,html:s,text:o="",replyTo:l,scheduledAt:f}){if(!e||!t||!s&&!o)throw new Error("Failed to send email: Missing required parameters.");typeof e=="string"&&(e=[e]),typeof l=="string"&&(l=[l]);let y=yield c(n(this,A),`/lm/${n(this,A).config.projectId}/email/send`,{method:"POST",body:{to:e,subject:t,fromName:r,html:s,text:o,replyTo:l,scheduledAt:f}});if(y.code!==200)throw new b(y.code,y.message)})}};A=new WeakMap;var C,k=class{constructor(e){a(this,C);u(this,C,e)}upload(e){return m(this,null,function*(){let t=new FormData;e.forEach(s=>{t.append("files",s)});let r=yield c(n(this,C),`/lm/${n(this,C).config.projectId}/file/batch`,{method:"POST",body:t});if(r.code!==200)throw new b(r.code,r.message);return r.data})}delete(e){return m(this,null,function*(){let t=yield c(n(this,C),`/lm/${n(this,C).config.projectId}/file/batch`,{method:"DELETE",body:{fileUrls:e}});if(t.code!==200)throw new b(t.code,t.message)})}};C=new WeakMap;var F,q=class{constructor(e){a(this,F);u(this,F,e),this.email=new U(e),this.file=new k(e)}};F=new WeakMap;var B=class{constructor(e){this.config=e,this.auth=new R(this),this.entities=new O(this),this.tools=new q(this),this.functions=new M(this)}};function Ce(i){return new B(i)}0&&(module.exports={EmailTool,EntitiesClient,EntityClient,FileTool,FunctionsClient,LumiAuthClient,LumiClient,ToolsClient,createClient});
//# sourceMappingURL=index.js.map